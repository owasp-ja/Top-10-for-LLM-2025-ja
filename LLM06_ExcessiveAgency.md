## LLM06:2025 過剰な自律性

### 説明

LLM ベースのシステムは、開発者によって、プロンプトに応答してアクションを実行するための機能を呼び出したり、拡張機能（ベンダーによって、ツール、スキル、またはプラグインと呼ばれることもある）を介して他のシステムとインターフェイスしたり、ある程度の自律性を付与されることが多いです。どの拡張機能を呼び出すかの決定は、入力プロンプトや LLM の出力に基づいて動的に決定する LLM「エージェント」に委譲することもできます。エージェントベースのシステムは通常、LLM を繰り返し呼び出します。

過剰な自律性は、LLM が誤動作する原因となっているものに関係なく、LLM からの予期しない、曖昧な、または操作された出力に応答して、有害なアクションを実行することを可能にする脆弱性です。一般的なトリガーは以下の通りです。

- 無害だが不適切な設計のプロンプトや、単に性能の低いモデルによって引き起こされるハルシネーション・コンファビュレーション（作話）
- 悪意のあるユーザー、以前に呼び出された悪意のある/侵害された拡張機能、または(マルチエージェント/共同作業システムでは)悪意のある/侵害されたピアエージェントからの直接/間接的なプロンプトインジェクション

過剰な自律性の根本的な原因は、一般的に以下の 1 つ以上あります。

- 過剰な機能性
- 過剰なパーミッション
- 過剰な自主性

過剰な自律性は機密性・完全性・可用性の各領域にわたって広範な影響をもたらす可能性があり、LLM ベースのアプリがどのシステムと相互作用できるかに依存します。

注：過剰な自律性は、LLM のアウトプットの精査が不十分であることを問題視するインセキュア・アウトプット・ハンドリングとは異なります。

### リスクの一般的な例

#### 1. 過剰な機能性

LLM エージェントは、システムの動作に必要でない機能を含む拡張機能にアクセスすることができます。例えば、開発者は LLM エージェントにリポジトリからドキュメントを読み込む機能を与える必要がありますが、彼らが選択したサードパーティの拡張機能には、ドキュメントを修正・削除する機能も含まれています。

#### 2. 過剰な機能性

ある拡張機能が開発段階で試され、より良い選択肢に取って代わられたとしても、元のプラグインは LLM エージェントで利用可能なままとなります。

#### 3. 過剰な機能性

オープンエンドな機能を持つ LLM プラグインは、アプリケーションの動作に必要なコマンド以外の入力命令を適切にフィルタリングできません。例えば、ある特定のシェルコマンドを実行する拡張機能は、他のシェルコマンドの実行を適切に防ぐことができません。

#### 4. 過剰なパーミッション

LLM 拡張機能はアプリケーションの意図した操作に必要でない、下流システム上のパーミッションを持ちます。例えば、データの読み取りを目的とした拡張機能は、SELECT パーミッションだけでなく、UPDATE、INSERT、DELETE パーミッションも持つ ID を使用してデータベースサーバーに接続します。

#### 5. 過剰なパーミッション

個々のユーザーのコンテキストで操作を実行するように設計された LLM 拡張機能は、一般的な高権限 ID で下流システムにアクセスします。例えば、現在のユーザーのドキュメントストアを読むための拡張機能は、すべてのユーザーのファイルにアクセスできる特権アカウントでドキュメントリポジトリに接続します。

#### 6. 過剰な自主性

LLM ベースのアプリケーションや拡張機能では、影響度の高いアクションを独自に検証・承認できない。例えば、ユーザーのドキュメントを削除できるようにする拡張機能は、ユーザーの確認なしに削除を実行します。

### 予防と緩和の戦略

過剰な自律性を防止するには、次のような対応が必要です。

#### 1. 拡張機能を最小化

LLM エージェントが呼び出すことを許可される拡張機能は、必要最小限のものに限定します。 例えば、LLM ベースのシステムが URL の内容を取得する機能を必要としない場合、そのような拡張機能は LLM エージェントに提供されるべきではありません。

#### 2. 拡張機能を最小化

LLM 拡張モジュールに実装する機能は、必要最小限のものに限定してください。例えば、ユーザのメールボックスにアクセスしてメールを要約する拡張機能は、メールを読む機能だけが必要かもしれません。

#### 3. オープンエンドな拡張を回避

可能な限り、オープンエンドな拡張機能（シェルコマンドの実行、URL の取得など）の使用は避け、より細かい機能を持つ拡張機能を使用します。例えば、LLM ベースのアプリケーションは、ファイルに出力を書き出す必要があるかもしれません。これをシェル関数を実行する拡張機能を使用して実装した場合、望ましくないアクションの範囲が非常に大きくなります（他のシェルコマンドも実行される可能性があります）。より安全な代替案としては、その特定の機能のみを実装した、特定のファイル書き込み拡張機能をビルドすることでしょう。

#### 4. 拡張機能のパーミッションを最小化

望ましくないアクションの範囲を制限するために、LLM 拡張機能が他のシステムに与える権限を必要最小限に制限します。例えば、顧客に購入を勧めるために商品データベースを使用する LLM エージェントは、「商品」テーブルへの読み取りアクセスだけが必要かもしれません。これは、LLM 拡張機能がデータベースへの接続に使用する ID に対して、適切なデータベースパーミッションを適用することで実施する必要があります。

#### 5. ユーザーのコンテキストで拡張機能を実行

ユーザの権限とセキュリティスコープを追跡し、あるユーザのために行われたアクションが、その特定のユーザのコンテキストで、必要最小限の権限で下流システム上で実行されるようにします。例えば、ユーザーのコード・リポジトリを読み込む LLM 拡張機能は、ユーザーが OAuth 経由で認証され、必要最小限のスコープで実行される必要があります。

#### 6. ユーザーの承認を要求

ヒューマン・イン・ザ・ループ制御を活用し、影響の大きいアクションを実行する前に人間が承認することを義務付けます。これは、（LLM アプリケーションの範囲外の）下流システムに実装してもよいし、LLM 拡張機能自体に実装してもよいです。例えば、ユーザーの代わりにソーシャルメディアコンテンツを作成し投稿する LLM ベースのアプリは、「投稿」操作を実行する拡張機能内にユーザー承認ルーチンを含めるべきです。

#### 7. 完全な仲介

アクションが許可されるかどうかを決定するために LLM に依存するのではなく、下流システムに認可を実装します。完全な仲介の原則を適用し、拡張機能を介して下流システムに対して行われるすべての要求が、セキュリティポリシーに照らして検証されるようにします。

#### 8. LLM 入出力のサニタイズ

OWASP の ASVS（Application Security Verification Standard）の勧告を適用するなど、セキュアコーディングのベストプラクティスに従います。開発パイプラインにおいて、静的アプリケーションセキュリティテスト（SAST）と動的・対話的アプリケーションテスト（DAST、IAST）を使用します。

以下のオプションは、過剰な自律性を防止するものではないが、引き起こされる損害のレベルを制限することができます。

- LLM 拡張機能と下流システムのアクティビティをログに記録して監視し、望ましくないアクションが行われている場所を特定し、それに応じて対応します。
- 一定の時間内に起こりうる望ましくない行動の回数を減らし、重大な損害が発生する前にモニタリングによって望ましくない行動を発見する機会を増やすために、レート制限を導入します。

### 攻撃シナリオの例

LLM ベースのパーソナルアシスタントアプリは、受信メールの内容を要約するために、拡張機能を使って個人のメールボックスにアクセスできます。この機能を実現するために、拡張機能にはメッセージを読む機能が必要ですが、システム開発者が使用するプラグインにはメッセージを送信する機能も含まれています。さらに、このアプリは間接的なプロンプトインジェクション攻撃に対して脆弱であり、悪意を持って作成された受信メールが LLM を騙して、ユーザーの受信トレイをスキャンして機密情報を探し出し、攻撃者のメールアドレスに転送するようエージェントに命令させます。これは以下の方法で回避できます。

- メールを読む機能だけを実装した拡張機能を使うことで、過剰な機能を排除する
- 読み取り専用スコープを持つ OAuth セッションを介してユーザーの電子メールサービスを認証することにより、過剰なパーミッションを排除する
- LLM 拡張機能によって作成されたすべてのメールをユーザーが手動で確認し、「送信」を押すことを要求することによって、過剰な自主性を排除する

あるいは、メール送信インターフェースにレート制限を導入することによって、引き起こされる損害を減らすこともできます。

### 参考リンク

1. [Slack AI data exfil from private channels](https://promptarmor.substack.com/p/slack-ai-data-exfiltration-from-private): **PromptArmor**
2. [Rogue Agents: Stop AI From Misusing Your APIs](https://www.twilio.com/en-us/blog/rogue-ai-agents-secure-your-apis): **Twilio**
3. [Embrace the Red: Confused Deputy Problem](https://embracethered.com/blog/posts/2023/chatgpt-cross-plugin-request-forgery-and-prompt-injection./): **Embrace The Red**
4. [NeMo-Guardrails: Interface guidelines](https://github.com/NVIDIA/NeMo-Guardrails/blob/main/docs/security/guidelines.md): **NVIDIA Github**
5. [Simon Willison: Dual LLM Pattern](https://simonwillison.net/2023/Apr/25/dual-llm-pattern/): **Simon Willison**
